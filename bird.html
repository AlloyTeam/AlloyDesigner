<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>bird</title>
  <style type="text/css">
html, body{height: 100%;margin: 0;}
  </style>
</head>
<body>
<canvas id="ctx" width="600" height="400"></canvas>	

<script type="text/javascript">
var canvas = document.getElementById("ctx");
var ctx = canvas.getContext("2d");

var WIDTH = document.body.offsetWidth;
var HEIGHT = document.body.offsetHeight;

canvas.width = WIDTH;
canvas.height = HEIGHT;

var Stage = {
  init: function(){
     Bird.init();
     Pipes.init();
  },
  status: {
     playing: 0
  },
  step: function(){
     var _this = this;

     this.clearStage();
     Bird.step();
     Pipes.step();

     if(this.status.playing){
       setTimeout(function(){
           _this.step();
       }, 0);
     }
  },

  clearStage: function(){
     ctx.clearRect(0, 0, WIDTH, HEIGHT);
  },

  start: function(){
      this.status.playing = 1;
      this.step();
  },

  lose: function(){
      this.status.playing = 0;
      this.clearStage();

      ctx.fillText("Lose!", WIDTH / 2, HEIGHT / 2);
  }
};

var R = 14;

//计算重力加速度
//预期时间
var expectT = 0.24;

//预期位移
var expectS = 20;
var G = - (2 * expectS / (expectT * expectT));

var Bird = {
    v0: 0,
    t0: 0,

    x0: 0,
    y0: 0,

    x: 0,
    y: 0,

    step: function(){
       
      //以s为单位
      var t = (+ new Date - this.t0) / 1000;

      var s = this.v0 * t - 0.5 * G * t * t;

      var y = this.y0 + s;

      this.y = y;


      this.drawBird(this.x0, y);
    },

    init: function(){
        var x0 = 40;
        var y0 = ~~ (HEIGHT / 2);

        this.x0 = x0;
        this.y0 = y0;

        this.v0 = 10;
        this.t0 = + new Date();

        this.x = x0;

        this.eventBind();
    },
    
    drawBird: function(x, y){
        ctx.beginPath();
        ctx.arc(x, y, R, 0, 2 * Math.PI);
        ctx.fill();
    },

    eventBind: function(){
        var _this = this;
        document.body.onclick = function(){
            _this.x0 = _this.x;
            _this.y0 = _this.y;
            _this.t0 = + new Date;
            _this.v0 = - 200;
            
        };
    }
};

//PIPE的移动速度
var PIPE_V = - 100;

//PIPE宽度
var PIPE_W = 20;

//空隙高度
var PIPE_KH = R * 2 + 80;
var Pipe = function(startX, startY){
  this.x0 = startX || WIDTH * Math.random();
  this.y0 = startY || 0;

  this.x = startX || WIDTH;
  this.y = startY || 0;

  //空隙的位置
  this.kPosition = (HEIGHT - 100) * Math.random() + 50;

  this.t0 = + new Date;
};

Pipe.prototype = {
    drawPipe: function(x, y){
       var upperHeight = this.kPosition;
       ctx.fillRect(x, 0, PIPE_W, upperHeight);

       var lowerHeight = HEIGHT - this.kPosition - PIPE_KH; 
       var lowerY = HEIGHT - lowerHeight;
       ctx.fillRect(x, lowerY, PIPE_W, lowerHeight);

    },
    step: function(){
       var t = (+ new Date - this.t0) / 1000;

       var s = PIPE_V * t;

       var x = this.x0 + s;

       this.x = x;

       this.drawPipe(x, this.y);

       if(this.checkCollision()){
         Stage.lose();
       }

       if(x < - PIPE_W){
         Pipes.addPipe();
       }
    },

    distance: function(p0, p1){
      return Math.sqrt(Math.pow(p0[0] - p1[0], 2) + Math.pow(p0[1] - p1[1], 2));
    },

    //检测碰撞
    checkCollision: function(){
      var centerY = this.kPosition + PIPE_KH / 2;
      var x = this.x;

      //四个关键点
      var keyPoints = [
        [x, this.kPosition],
        [x, this.kPosition + PIPE_KH],
        [x + PIPE_W, this.kPosition],
        [x + PIPE_W, this.kPosition + PIPE_KH]
      ];

      var birdX = Bird.x;
      var birdY = Bird.y;

      var birdPosition = [birdX, birdY];

      //四个垂直扩展点
      var derectPoints = [
        [birdX, this.kPosition],
        [birdX, this.kPosition + PIPE_KH],
        [x, birdY],
        [x + PIPE_W, birdY]
      ];

      for(var i = 0; i < derectPoints.length; i ++){
        var point = derectPoints[i];

        //x < px < x + p_w  && (y < k_p || y > k_p + p_h)
        if(point[0] >= x && point[0] <= x + PIPE_W && (point[1] < this.kPosition || point[1] > this.kPosition + PIPE_KH)){
          if(this.distance(birdPosition, point) <= R){
            return true;
          }
        }
      }

      //检查四个关键点的距离是否越标
      for(var i = 0; i < keyPoints.length; i ++){
        var point = keyPoints[i];

        if(this.distance(birdPosition, point) <= R){
          return true;
        }
      }

      return false;
    }
};

var PIPE_SPLIT_DIS = 160;
//水管管理器
var Pipes = {
  init: function(){
      //pipe池
      this.pipes = [];

      var startX = WIDTH + PIPE_SPLIT_DIS * 1;
      var n = ~~ (WIDTH / PIPE_SPLIT_DIS + 1);

      for(var i = 0; i < n; i ++){
        var p = new Pipe(startX + i * PIPE_SPLIT_DIS);
        this.pipes.push(p);
      }
  },

  step: function(){
     for(var i = 0; i < this.pipes.length; i ++){
       this.pipes[i].step();
     }
  },

  addPipe: function(){
     this.pipes.shift();
     this.pipes.push(new Pipe(this.pipes[this.pipes.length - 1].x + PIPE_SPLIT_DIS));
  }
};

Stage.init();
Stage.start();
</script>
</body>
</html>
